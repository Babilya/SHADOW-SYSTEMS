from aiogram import Router, F
from aiogram.types import CallbackQuery, Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command

router = Router()

HELP_SECTIONS = {
    "botnet": """══════════════════════════════════════
      🤖 BOTNET — УПРАВЛІННЯ БОТАМИ
══════════════════════════════════════
<i>Централізований контроль мережі облікових записів</i>

<b>📋 ЩО ЦЕ ТАКЕ?</b>
Модуль для управління Telegram ботами та обліковими записами. Додавайте, видаляйте, моніторте та контролюйте всі боти з одного місця.

<b>⚡ ОСНОВНІ ФУНКЦІЇ:</b>
├ Додавання ботів з телефонних номерів та сесій
├ Контроль статусу кожного бота у реальному часі
├ Ротація проксі для забезпечення анонімності
├ Прогрів ботів перед використанням у кампаніях
└ Моніторинг статусу мережі 24/7
──────────────────────────────────────
<b>📖 ЯК КОРИСТУВАТИСЯ:</b>
├ 1. Виконайте /botnet для відкриття модуля
├ 2. Натисніть "Додати ботів" та оберіть спосіб
├ 3. Завантажте CSV файл з номерами телефонів
├ 4. Налаштуйте проксі-сервери для ротації
└ 5. Активуйте цикл прогріву облікових записів
══════════════════════════════════════""",

    "osint": """══════════════════════════════════════
      🔍 OSINT & ПАРСИНГ
══════════════════════════════════════
<i>Інструменти розвідки та збору даних</i>

<b>📋 ЩО ЦЕ ТАКЕ?</b>
Інструмент для пошуку, аналізу та парсингу даних з Telegram. Знаходить потрібну аудиторію на основі ключових слів, геолокації та інтересів.

<b>⚡ ОСНОВНІ ФУНКЦІЇ:</b>
├ Геосканування по назві міста або координатах
├ Аналіз користувачів (активність та інтереси)
├ Парсинг чатів та каналів за ключовими словами
├ Експорт контактів у CSV форматі
└ Журнал усіх сканувань та операцій
──────────────────────────────────────
<b>📖 ПРИКЛАДИ ВИКОРИСТАННЯ:</b>
├ 📍 Пошук аудиторії за геолокацією міста
├ 🎯 Парсинг контактів з тематичних груп
├ 💬 Моніторинг активності конкурентів
└ 📊 Аналітика профілів користувачів
══════════════════════════════════════""",

    "analytics": """══════════════════════════════════════
        📊 АНАЛІТИКА КАМПАНІЙ
══════════════════════════════════════
<i>Центр аналізу результатів розсилок</i>

<b>📋 ЩО ЦЕ ТАКЕ?</b>
Дашборд для аналізу кампаній. Показує метрики розсилок, успішність, ROI, sentiment-аналіз та прогнози ризиків.

<b>📈 ОСНОВНІ МЕТРИКИ:</b>
├ Кількість розсилок та їх статуси виконання
├ CTR (Click-Through Rate) — показник кліків
├ Конверсія та ROI для кожної кампанії
└ Блокування та помилки доставки
──────────────────────────────────────
<b>🤖 AI SENTIMENT ANALYSIS:</b>
├ 😊 Позитивні відповіді від аудиторії
├ 😐 Нейтральні відповіді та ігнорування
└ 😠 Негативні відповіді та скарги

<b>⚠️ ПРОГНОЗ РИЗИКІВ:</b>
├ 🟢 Низький — безпечно продовжувати
├ 🟡 Середній — рекомендовано затримку
└ 🔴 Високий — пауза мінімум 24 години

<b>📄 ЗВІТИ:</b> щогодинні, щоденні, щотижневі з експортом
══════════════════════════════════════""",

    "team": """══════════════════════════════════════
        👥 УПРАВЛІННЯ КОМАНДОЮ
══════════════════════════════════════
<i>Модуль координації менеджерів проекту</i>

<b>📋 ЩО ЦЕ ТАКЕ?</b>
Модуль для управління командою. Розподіляйте задачі між менеджерами, контролюйте якість роботи, управляйте доступом.

<b>⚡ ОСНОВНІ ФУНКЦІЇ:</b>
├ Додавання менеджерів через INV-коди
├ Встановлення ролей та рівнів дозволів
├ Розподіл кампаній між членами команди
├ Рейтинг менеджерів за ефективністю
└ Статистика активності кожного члена
──────────────────────────────────────
<b>👤 РОЛІ МЕНЕДЖЕРІВ:</b>
├ 👤 Оператор — виконує розсилки
├ 🔍 Аналітик — аналізує результати
└ 🛡️ Адмін — управління командою

<b>⭐ РЕЙТИНГ:</b>
├ Швидкість виконання поставлених задач
├ Якість роботи (успішні кампанії)
├ Надійність (кількість помилок)
└ Комунікація та зворотний зв'язок
══════════════════════════════════════""",

    "subscriptions": """══════════════════════════════════════
        📦 РІВНІ ДОСТУПУ
══════════════════════════════════════
<i>Система ліцензування SHADOW</i>

<b>🔑 АКТИВАЦІЯ ДОСТУПУ:</b>
Система працює на основі ліцензійних ключів. Для отримання ключа зверніться до адміністратора або подайте заявку.

<b>📋 ДОСТУПНІ РІВНІ:</b>

<b>📦 БАЗОВИЙ:</b>
├ До 5 ботів у мережі
├ 1 менеджер у команді
└ Базові функції розсилок

<b>⭐ СТАНДАРТ:</b>
├ До 50 ботів у мережі
├ 5 менеджерів у команді
└ Повний функціонал системи

<b>👑 ПРЕМІУМ:</b>
├ До 100 ботів у мережі
├ Необмежено менеджерів
├ AI функції та аналітика
└ Пріоритетна технічна підтримка

<b>💎 ЕНТЕРПРАЙЗ:</b>
├ Індивідуальна конфігурація під задачі
├ API доступ для інтеграцій
└ VIP підтримка 24/7
──────────────────────────────────────
<b>📨 ЯК ОТРИМАТИ КЛЮЧ:</b>
Подайте заявку через меню або напряму до адміністратора
══════════════════════════════════════""",

    "activation": """══════════════════════════════════════
        🔑 АКТИВАЦІЯ ЛІЦЕНЗІЇ
══════════════════════════════════════
<i>Система ключів SHADOW</i>

<b>📋 ЯК АКТИВУВАТИ:</b>
├ 1. Отримайте ключ від адміністратора системи
├ 2. Введіть ключ через меню "Активувати ключ"
└ 3. Дочекайтесь підтвердження активації

<b>🔐 ФОРМАТ КЛЮЧА:</b>
<code>SHADOW-XXXX-XXXX-XXXX</code>

<b>⚡ ОСОБЛИВОСТІ:</b>
├ Миттєва активація після введення ключа
├ Прив'язка до Telegram акаунту
├ Автоматичне оновлення статусу
└ Захист від дублювання ключів
──────────────────────────────────────
<b>⚠️ ВАЖЛИВО:</b> Кожен ключ активується лише один раз
══════════════════════════════════════""",

    "settings": """══════════════════════════════════════
        ⚙️ НАЛАШТУВАННЯ СИСТЕМИ
══════════════════════════════════════
<i>Конфігурація та персоналізація</i>

<b>👤 ПРОФІЛЬ:</b>
├ Змінити ім'я та аватар профілю
├ Двофакторна аутентифікація для захисту
├ Вихід з інших пристроїв та сесій
└ Видалення акаунту та всіх даних

<b>👻 ПРИВИДНИЙ РЕЖИМ:</b>
├ ✅ Приховати статус онлайну від команди
├ ✅ Прихована активність для менеджерів
└ ✅ Анонімні записи в логах системи

<b>🔔 СПОВІЩЕННЯ:</b>
├ ✅ Push-сповіщення на мобільний
├ ✅ SMS сповіщення про критичні події
├ ✅ Email дайджест щоденний/щотижневий
└ ✅ Custom Alert rules для подій

<b>🔐 БЕЗПЕКА:</b>
├ ✅ Зміна пароля та кодів доступу
├ ✅ Список активних пристроїв
├ ✅ Контроль сесій та авторизацій
└ ✅ IP whitelist для обмеження доступу
══════════════════════════════════════"""
}

def help_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="🤖 BOTNET", callback_data="help_botnet")],
        [InlineKeyboardButton(text="🔍 OSINT", callback_data="help_osint")],
        [InlineKeyboardButton(text="📊 ANALYTICS", callback_data="help_analytics")],
        [InlineKeyboardButton(text="👥 TEAM", callback_data="help_team")],
        [InlineKeyboardButton(text="📦 SUBSCRIPTIONS", callback_data="help_subscriptions")],
        [InlineKeyboardButton(text="💳 PAYMENTS", callback_data="help_payments")],
        [InlineKeyboardButton(text="⚙️ SETTINGS", callback_data="help_settings")],
        [InlineKeyboardButton(text="◀️ Назад", callback_data="back_to_menu")]
    ])

def help_description() -> str:
    return """══════════════════════════════════════
        📚 ДОВІДКА SHADOW SYSTEM
══════════════════════════════════════

<b>🔧 Виберіть розділ для детальної інформації:</b>"""

@router.message(Command("help"))
async def help_cmd(message: Message):
    await message.answer(help_description(), reply_markup=help_kb(), parse_mode="HTML")

async def help_menu(message: Message):
    """Функція для виклику з інших модулів"""
    await message.edit_text(help_description(), reply_markup=help_kb(), parse_mode="HTML")

@router.callback_query(F.data.startswith("help_"))
async def show_help(query: CallbackQuery):
    section = query.data.replace("help_", "")
    await query.answer()
    
    if section in HELP_SECTIONS:
        new_text = HELP_SECTIONS[section]
        back_kb = InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="◀️ Назад", callback_data="back_to_menu")]])
        
        if query.message.text != new_text or query.message.reply_markup != back_kb:
            try:
                await query.message.edit_text(new_text, reply_markup=back_kb, parse_mode="HTML")
            except Exception:
                pass
