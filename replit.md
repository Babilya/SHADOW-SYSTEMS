# Shadow System v2.0

## Overview
SHADOW SYSTEM iO v2.0 is a professional Ukrainian-language Telegram marketing automation platform. It provides comprehensive functionality for managing bot networks, mass mailings, OSINT reconnaissance, team collaboration, and AI-powered features. The system uses SHADOW license keys for authorization (no payment/balance system).

## User Preferences
- Concise, high-level summaries over granular details
- No changelogs or date-wise entries
- Focus on core architectural decisions
- Ukrainian interface with styled formatting (dividers, emoji, button layouts)

## System Architecture

### Directory Structure
```
├── bot.py                  # Main entry point
├── config/                 # Configuration (settings, tariffs)
├── core/                   # Core services
│   ├── ai_service.py       # AI/GPT integration (GPT-5)
│   ├── role_constants.py   # Single source of truth for UserRole
│   ├── roles.py            # Permission system
│   ├── rate_limiter.py     # Token bucket rate limiting
│   ├── message_queue.py    # Async message queue (3 workers)
│   ├── mailing_scheduler.py# Campaign scheduling
│   ├── anti_fraud.py       # Behavioral analysis
│   ├── segmentation.py     # User tagging
│   └── alerts.py           # Notification system
├── database/
│   ├── models.py           # SQLAlchemy models (User, Funnel, FunnelStep, etc.)
│   └── crud.py             # Database operations
├── handlers/               # Telegram command handlers
├── keyboards/              # Role-specific menus
├── middlewares/            # Security, role checking
├── services/               # Business logic (user_service, funnel_service)
└── utils/                  # Database utilities
```

### Core Architectural Decisions
- **Unified Role System:** Single `UserRole` class in `core/role_constants.py` imported by all modules
- **RBAC:** ROOT/ADMIN, LEADER, MANAGER, GUEST with hierarchical permissions
- **FSM Navigation:** Proper state clearing on back navigation
- **Async Operations:** aiogram 3.3 + asyncpg for non-blocking I/O
- **Security-First:** SHADOW keys, Telegram ID binding, IP whitelists, audit logging
- **AI Integration:** Replit AI Integrations (OpenAI-compatible, GPT-5)

### Role Hierarchy
| Role | Level | Access |
|------|-------|--------|
| GUEST | 0 | View tariffs, submit applications |
| MANAGER | 1 | Mailings, OSINT, botnet |
| LEADER | 2 | Team management, funnels, license generation |
| ADMIN | 3 | Full system control |

## Key Features

### Implemented
- **Bot Network:** Session import, encryption, warming cycles, proxy management
- **Campaigns:** Broadcast, targeted, drip, sequential with A/B testing
- **OSINT:** Telegram analysis, DNS/WHOIS, geo scanner, AI reports
- **Funnels:** Full CRUD with photo support, tariff config, statistics
- **AI Services:** Text generation, sentiment analysis, OSINT reports, message rewriting
- **Security:** Rate limiting, anti-fraud, encrypted sessions, audit logs
- **Team CRM:** Manager management, invite codes, referrals

### Services (19 Active)
1. RateLimiter (30 req/sec global)
2. MessageQueue (3 workers)
3. MailingScheduler
4. AntiFraud
5. Segmentation
6. KeyNotifications
7. SecurityCache
8. AuditLogger
9. EncryptionManager
10. AIService

## External Dependencies
- **aiogram 3.3:** Telegram Bot API
- **SQLAlchemy + asyncpg:** PostgreSQL database
- **Telethon:** Session management
- **OpenAI (via Replit AI):** AI features
- **ReportLab:** PDF generation
- **Jinja2:** HTML templates

## Authorization
- **Leaders:** SHADOW keys (unique, ID-bound)
- **Managers:** INV codes (generated by Leaders)
- No payment/balance system - pure license activation

## UI/UX Standards
- Ukrainian language throughout
- Dividers: ═══════════════════════
- Button layouts: 1/2/3 per row
- HTML formatting: <b>, <i>, <code>
- Lists: ├ └ tree structure

## Recent Changes (December 2025)

### Bug Fixes
- Fixed "message is not modified" TelegramBadRequest errors with safe_edit_message helper
- Fixed "query is too old" callback errors handling
- Fixed missing logger import in role_middleware.py
- Fixed RoleMiddleware to use correct set_user_role method

### New Features
- Added RoleMiddleware to dispatcher for automatic role injection
- Registered funnels_router for funnel management
- Added missing callback handlers:
  - back_to_menu, profile_main, texting_main, settings_main
  - warming_main, warming_start, warming_stop, support
  - Full admin panel: admin_roles, admin_apps, admin_keys, admin_emergency
  - System controls: system_restart, system_clear_cache
  - Emergency: emergency_activate, emergency_broadcast, emergency_lockdown

### Improvements
- Enhanced error logging in safe_edit_message function
- All admin panel buttons now have working handlers
- Better navigation flow between menus

### Registered Routers (December 2025)
All feature routers now properly registered in main.py:
- warming_router (account warming with profiles)
- mailing_router (broadcast/targeted campaigns)
- geo_router (geo scanner)
- proxy_router (proxy management)
- advanced_router (scheduler, A/B testing, auto-responder, segmentation)
- osint_handler_router (OSINT commands)
- texting_router (text creation/templates)
- scheduler_router (campaign scheduling)

### Warming Profiles Added
- Conservative (~20 actions/day)
- Standard (~50 actions/day)
- Aggressive (100+ actions/day)
- Custom (manual settings)

## AI Integration Notes
AI features require OpenAI API key. When key is missing, system operates in graceful degradation mode - all non-AI features remain fully functional.

## Communication & Templates System (December 2025)

### Mailing Templates (services/template_service.py)
- **TemplateService**: CRUD operations for mailing templates
- Categories: welcome, promo, news, reminder, alert, general
- Variable support: {name}, {username}, {date}, {time}
- Public/private templates with usage tracking
- **SchedulerService**: Interval-based scheduling
- Schedule types: once, interval, daily, weekly, monthly
- Target by roles or specific user IDs

### Support Ticket System (services/support_service.py)
- **SupportService**: Full ticket lifecycle management
- Categories: technical, billing, account, feature, bug, general
- Priorities: low, normal, high, urgent
- Statuses: open, in_progress, waiting, resolved, closed
- Threaded messages with attachments
- Admin assignment and rating system

### Notification & Ban System (services/notification_service.py)
- **NotificationService**: Role-based targeting
- Target types: all, role, multi_role, personal, project
- Types: info, warning, success, error, announcement, update, maintenance
- Priority levels with read tracking
- **BanService**: User ban management
- Ban types: temporary, permanent, warning
- Appeal system with admin review
- Auto-expiry for temporary bans
- **ProjectStatsService**: Per-project analytics

### UI Keyboards
- keyboards/templates_kb.py: Template management UI
- keyboards/support_kb.py: Ticket system UI
- keyboards/notifications_kb.py: Notifications, bans, stats UI

### Registered Handlers
- templates_router: Template CRUD, scheduling
- support_router: Ticket creation, responses, status
- notifications_router: Notifications, bans, statistics

## ТЗ Compliance (December 2025)

### Security & Encryption
- **EncryptionManager**: AES-256-CBC + HKDF key derivation (core/encryption.py)
- Separate keys for sessions, proxies, data
- Fallback XOR encryption when cryptography unavailable

### Session Management
- **SessionValidator**: Full validation with 5 tests (core/session_validator.py)
  - Connection test
  - Authorization test
  - Rate limit test
  - Privacy test
  - Functionality test
- Supports: Telethon .session, Pyrogram JSON, TData archives, StringSession

### BotSession Model (Extended)
20+ fields including:
- Device fingerprint, anti-detect profile
- Proxy configuration (type, config JSON)
- Warming phase & profile tracking
- Flood wait timestamps
- Success rate & message statistics
- Tags for filtering

### Campaign Manager (Advanced)
- **AdvancedCampaignManager**: Worker pool with async queues (core/advanced_campaign_manager.py)
- Weighted round-robin bot selection
- Adaptive delay calculation based on success rate
- Real-time statistics with lock-safe updates
- A/B testing support
- Dynamic delay adjustment

### OSINT Engine (Extended)
- **AdvancedOSINTEngine**: Deep analysis system (core/advanced_osint_engine.py)
- Network graph building with influence scores
- Threat assessment with risk scoring
- Pattern detection (phones, crypto wallets, coordinates, emails)
- Suspicious keyword detection (UK/RU/EN)
- Evidence storage with hash verification

### Real-Time Monitor
- **RealTimeMonitor**: Telethon events listener (core/realtime_monitor.py)
- NewMessage, ChatAction, MessageEdited handlers
- Pattern matching: coordinates (decimal, DMS, MGRS), phones, crypto, frequencies
- Threat keywords by level (critical/high/medium/low)
- Auto-actions: block_user, log_evidence, alert_admins
- Configurable thresholds per metric

### Rapid OSINT Parser
- **RapidOSINTParser**: Fast channel scanning (core/rapid_osint.py)
- Multi-channel parallel scanning
- Pattern extraction: coordinates, phones (UA/RU), crypto (BTC/ETH/USDT), frequencies
- Threat scoring system with keyword detection
- JSON report generation with evidence
- User lookup functionality

### Mass Sender & PsyOps
- **MassSender**: Telegram mass messaging (core/mass_sender.py)
- Batch sending with adaptive delays
- FloodWait handling with retry logic
- Progress callbacks and statistics
- **PsyOpsCampaign**: Psychological operations templates
- Alert/disinformation/panic message types
- Personalized messaging support

### Alert Thresholds System
- **AlertThresholdsSystem**: Dynamic rules engine (core/alert_thresholds.py)
- Rule types: MESSAGE_FREQUENCY, KEYWORD_DETECTION, COORDINATE_LEAK, etc.
- Actions: LOG, ALERT, BLOCK_USER, NOTIFY_ADMIN, ESCALATE
- Cooldown and priority settings
- Violation tracking with evidence
- Metrics recording and cleanup
